string example = @"....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...";
string input = @"#.............#.#...........................................................#..........#...........................#..........#...
............#......................#.......#..#.........#...................##....................................................
..............#...........#..#.......#.........#.#...........................#................................#......#............
.....#......................................#......#..#...................#....................#......................#...........
...#............................#................................#................................................................
..........#..................#.....#......................................................#.......................................
..#........#.......#.#...............................................................#......#.................................#...
.#....#................#................#.....#...................#...............................................#..#............
.......................................................................................#...#.#....#........##......#........#.#.##
............................................#.................#.....................#..........................#..................
....#..........##......................#.................................................................................#........
......#.............##.........#.......#.........#.......#.............#...#.......#..............................................
.#............................................................................#..........#....#...................................
...#..#....#..............................#...........................................................................#...........
.............#....................................................................................................................
................................#..................##...................................#...............................#......#..
..........#.........#.................#..........###...........................................#............#...#.................
.............#....................................#.......#.#.#............#............................................#.........
......#.#..............................................................................................#.........................#
...#...#.........#.........#..#......#................##.................#........................................................
.................................#......................#........#................#........................#......................
.......................##..............#................#................#..............................#.........................
.......#...#.....#.....##........................#..................##.....#......................................................
.............................................#...........................#..........................................#.....#.......
.........................#...............#....#..............#.......#...............#.#.................#.................#......
...........................................................#....#..................................#..............................
..........................#.................................................#............................##....#..................
.................#...#.........................................................#........................#.....#..#................
.........................#....#................................................#...#.....................#....#...........#.......
................................................##.......#.#....................................#.......##........................
..........##...#.......................#....#..#....................#........................#....................................
#......#.......................#............#.....................................................................#...............
.......#.......#...#..#..........#.......................................#.............#......#...................................
...............#............#..................#.................................................................................#
.......#...........#.......................##.....#.........#...........#...................#......#.........#.............##....#
...................#.........................#......#..........................................#..........#.........#......#......
.....#............#..............#...#......#....................#.............#..................................................
................................................#........#.....#...................#.....................................#.....#..
......................#.#...##......................##...............................................#.................#..........
#...................#.........................#...........#.....#................#.....................#...................#......
....#................#.....#.............#.....................................#....#...#.................................#.......
.........#.....................................................................................................#.#.......#........
.........#..........##..............................#............................#.#.............................#................
#....#.#..............................................##...#...#...............#.............#....................................
........#..#.#...................#.......................................................................#.............#..#.#...#.
.................................................................................................................#.......#........
............................................#..#...............##........#..........#.......................................#....#
........#...........................#............................#.....#........................#..........#...#..........#.......
.#...........#...................................................#...........................................#................#.#.
............#...............................#........#...........#..........#...........#.#..............#........................
...............................................................................##.#................#..............................
.#.......................#.#...........#..................................#.......................................................
..#..............................................##................#.......#....#..............#.....................#...#........
...................#.....#................................................#..........#.........#.........#.....................#..
........#................#................................................................................#......#................
...................#...#....#.........................#.........................#....................#..........................#.
.................#.......................................................#................................................#.......
..#...........................##.#.............#..#............................................#.......................#.#........
..#......#.........................................................................#.......................#......................
...........................................................................................................#............#......#..
............................................................^..........................................#..........#...............
..#.........#....................#..........................................#........#.........................................#..
........#...............#....#.............#......#.........................................................................#.....
.........#......#.....#..............#...........................................................#..............#.................
.........#...................................................#...###...........#.......#.##.......................................
.....................##.................#.........##.....................#................#................#.........#............
.......................................................................#..............#..............#.................#..........
.##.........#..........................................................................#....................................#.....
.........................#.............................#........................................................................#.
........#.............................................#......#....#.....................................#....................#....
........#...#..............................................................................#.........#............................
..............................#................................#..........#..............#..................................#.....
........##..#...................................#................................#.................#.........#......#..#........#.
..................#......#...................................................................#....................................
..........#.............#..............#........#............#...............#..#..........#..............#.#...#............#....
............................##....#..............#......................................................................#.........
...............................................#.....#...........#.....##...............#..#......................................
.........................#.......#...............................#...........#.........#...........#....#.........................
.#............#...#...............#..............................................................#..........................#....#
#...........#......................................................#.............................#......#.........................
..................................................#....#...............#.........................#................................
................................................#..........................#.......#..............................#....##.......#.
........#......#..#............#................#............................#......#.##.........#....................#..#........
.......................................................#..#.#....................#..#......................................#......
.....................#.......................................................................#............#.......................
.....................##........................#...................#.....................#........................................
..........................#...........................................................................................#...........
..#..........#...................#..............##..#.....................#...................#..............#...........#........
#................................#....##......#.............#..............#.......................#.........#...........#........
..................#................#...............................#.....#..........#................#..............#.............
................#.#.........#.....##...............................................................#..............#...............
..#...............................................................................................#...............................
..........#.................#...........#.......#.........................#...#.......#...........................................
..##....#......................................#.#.......................................#.................#......................
.......................#..#...#.##......................................................................#.........#...#...........
...............#.........#..............#.....................................................#...................#...............
......#.................#............#......#...................#..#.........................#........................#........#..
......................................................................#...........................#........#......................
..........#..........#........................#.............##....................................................................
....#................................................#.......................#................#...............#...................
.................#....................................................#......#....................................................
.#........#.......................................................................................................................
......##..................#....#......#.................#....................#.....................#..#...........#...............
#...#...#...#..............#........#.......................#.#..........#...............................#......#.................
#...#...................#.............#........#..........#...............................................................#...#...
..#................................#...#.........................#...................#......#.....................................
...#...###..........#............#...............................................................#..........#.....................
............#..............#.......#.....#..........#.....#.........................................................#............#
..#......................#..#...#................................#......#.......#.....#..................#.........#..............
....##......#.......................................................#..............................................#..............
...............................#.....#....#.................................................#.......#............#................
..........#....#......................#........#..........................#......#................................................
......#.............................#...........#..................#...........................#................................#.
...........................##..........................................#.....#.#.....................#................#...........
..#..............#.........................................................#........................#.........#.................#.
#.....#.....#......................#....................#........................................#...........#...........#......#.
.......................................#..#................................#.........#.......#..#.....#..........................#
..........#..............##...............#..........................................................#......#......#......#....#..
.............#..............#..#......#........#..#......##.......................#...........#.......#...........................
......................#.......................................#.......#..#.....................................#.........#...##...
...........................#...........................#......#....#.............................#.............................#..
..................#............................#....#........##.........................#..............#.............#............
.......#....................#.....#........#.......#.#...#...............#.....#.#.........................#.......#.#............
.....#.........#.......#..........#.................#..#...#..................................................##..................
................#........................................................#........................................................
....##......#........#..................#.........................#...................................#...#...................#...
..............#....................#.......#.......................#.............#......#..............#..........................
...........................#..............#.....#............#.....................#........#....#.......................#........
........#..##................#.....#.#..............#..............................#........................#.........#...........
.........................................................#...........................##..........#........#.##....................";

RunPart1(input);
RunPart2(input);

static void RunPart1(string input)
{
    int result = 0;
    var lines = input.Split('\n').ToArray();

    char[][] puzzle = new char[lines.Length][];

    for (int i = 0; i < lines.Length; i++)
        puzzle[i] = lines[i].ToCharArray();

    MoveGuardAndMarkPositions(puzzle, FindStartingPosition(puzzle));

    Console.WriteLine($"Part 1 result: {CountGuardPositions(puzzle)}");
}

static void RunPart2(string input)
{
    int result = 0;
    var lines = input.Split('\n', StringSplitOptions.RemoveEmptyEntries)
    .Select(line => line.Trim().ToCharArray())
    .ToArray();

    char[][] defaultPuzzle = new char[lines.Length][];

    for (int i = 0; i < lines.Length; i++)
        defaultPuzzle[i] = lines[i];

    
    List<char[][]> puzzles = CreateNewPuzzles(defaultPuzzle);

    foreach (var puzzle in puzzles)
    {
        var startingPosition = FindStartingPosition(defaultPuzzle);
        MoveGuardAndCheckForLoops(puzzle, startingPosition, ref result);
    }

    Console.WriteLine($"Part 2 result: {result}");
}

static int[] FindStartingPosition(char[][] puzzle)
{
    for (int i = 0; i < puzzle.Length; i++)
    {
        for (int j = 0; j < puzzle[i].Length; j++)
        {
            if (puzzle[i][j] == '^')
            {
                return new[] { i,j };
            }
        }
    }

    return null;
}

#region Part 1
static void MoveGuardAndMarkPositions(char[][] puzzle, int[] guardPosition)
{
    bool collided = false;
    int[] firstCollision = new int[2];
    int rows = puzzle.Length;
    int cols = puzzle[0].Length;

    int[][] directions = new int[][]
    {
        new int[] {-1,  0},
        new int[] { 0,  1},
        new int[] { 1,  0},
        new int[] { 0, -1},
    };

    int currentDirectionIndex = 0;
    int[] currentDirection = directions[0];

    while (true)
    {
        int newRow = guardPosition[0] + currentDirection[0];
        int newCol = guardPosition[1] + currentDirection[1];

        if (newRow >= 0 && newRow < rows && newCol >= 0 && newCol < cols)
        {
            if (puzzle[newRow][newCol] != '#')
            {
                puzzle[guardPosition[0]][guardPosition[1]] = 'X';
                guardPosition[0] = newRow;
                guardPosition[1] = newCol;
            }
            else
            {
                currentDirectionIndex = (currentDirectionIndex + 1) % 4;
                currentDirection = directions[currentDirectionIndex];
            }
        }
        else
        {
            puzzle[guardPosition[0]][guardPosition[1]] = 'X';
            break;
        }
    }
}

static int CountGuardPositions(char[][] puzzle)
{
    int result = 0;

    for (int i = 0; i < puzzle.Length; i++)
    {
        for (int j = 0; j < puzzle[i].Length; j++)
        {
            if (puzzle[i][j] == 'X')
            {
                result++;
            }
        }
    }

    return result;
}
#endregion

#region Part 2
static List<char[][]> CreateNewPuzzles(char[][] puzzle)
{
    List<char[][]> puzzles = new();

    for (int i = 0; i < puzzle.Length; i++)
    {
        for (int j = 0; j < puzzle[i].Length; j++)
        {
            if (puzzle[i][j] is '^' or '#')
                continue;

            char[][] newPuzzle = new char[puzzle.Length][];
            for (int k = 0; k < puzzle.Length; k++)
            {
                newPuzzle[k] = (char[])puzzle[k].Clone();
            }

            newPuzzle[i][j] = '#';
            puzzles.Add(newPuzzle);
        }
    }

    return puzzles;
}

static void MoveGuardAndCheckForLoops(char[][] puzzle, int[] guardPosition, ref int result)
{
    List<int[]> collisions = new();
    int rows = puzzle.Length;
    int cols = puzzle[0].Length;

    int[][] directions = new int[][]
    {
        new int[] {-1,  0},
        new int[] { 0,  1},
        new int[] { 1,  0},
        new int[] { 0, -1},
    };

    int currentDirectionIndex = 0;
    int[] currentDirection = directions[0];

    while (true)
    {
        int newRow = guardPosition[0] + currentDirection[0];
        int newCol = guardPosition[1] + currentDirection[1];

        if (newRow >= 0 && newRow < rows && newCol >= 0 && newCol < cols)
        {
            if (puzzle[newRow][newCol] != '#')
            {
                guardPosition[0] = newRow;
                guardPosition[1] = newCol;
            }
            else
            {
                if (collisions.Any(arr => arr.SequenceEqual(new[] { newRow, newCol, currentDirectionIndex })))
                {
                    result++;
                    break;
                }
                else
                {
                    collisions.Add(new[] { newRow, newCol, currentDirectionIndex });
                }
                currentDirectionIndex = (currentDirectionIndex + 1) % 4;
                currentDirection = directions[currentDirectionIndex];
            }
        }
        else
        {
            break;
        }
    }
}
#endregion